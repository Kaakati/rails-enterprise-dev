---
name: reactree-init
description: |
  Initialize ReAcTree plugin in the current Rails project. Creates configuration,
  validates prerequisites, sets up working memory, and optionally copies bundled
  skills. Run this first when using the plugin in a new project.
allowed-tools: ["Bash", "Read", "Write", "Glob", "AskUserQuestion"]
---

# ReAcTree Plugin Initialization

You are initializing the ReAcTree plugin for this Rails project. Follow these steps systematically and provide clear feedback at each stage.

## Phase 1: Validate Plugin Installation

First, determine the plugin's actual location using `${CLAUDE_PLUGIN_ROOT}`:

```bash
# CLAUDE_PLUGIN_ROOT is set by Claude Code to the plugin's actual location
# This works regardless of how the plugin was installed (local, global, marketplace)
PLUGIN_ROOT="${CLAUDE_PLUGIN_ROOT:-}"

# Fallback to local path if not set (for manual testing)
if [ -z "$PLUGIN_ROOT" ]; then
  if [ -d ".claude/plugins/reactree-rails-dev" ]; then
    PLUGIN_ROOT=".claude/plugins/reactree-rails-dev"
  else
    echo "ERROR: CLAUDE_PLUGIN_ROOT not set and no local plugin found"
    echo "Plugin location could not be determined"
    exit 1
  fi
fi

echo "Plugin located at: $PLUGIN_ROOT"

# Check plugin directory exists
ls -la "$PLUGIN_ROOT/" 2>/dev/null

# Check hooks.json exists
cat "$PLUGIN_ROOT/hooks/hooks.json" 2>/dev/null | head -5

# Check scripts are executable
ls -la "$PLUGIN_ROOT/hooks/scripts/"*.sh 2>/dev/null
```

**Expected**: Plugin directory with hooks.json and executable scripts.

**If CLAUDE_PLUGIN_ROOT is empty**: The command will check for a local installation at `.claude/plugins/reactree-rails-dev/`.

**If neither exists**: Report error - plugin not installed correctly.

## Phase 2: Check Skills Directory

Check if the project has skills:

```bash
# Check skills directory
ls -la .claude/skills/ 2>/dev/null

# Count skill directories (subtract 1 for the directory itself)
skill_count=$(find .claude/skills -maxdepth 1 -type d 2>/dev/null | wc -l)
echo "Found $((skill_count - 1)) skills"
```

### Case A: Skills Directory Exists WITH Skills

If `.claude/skills/` exists and has skills, use AskUserQuestion to ask:

```
Found X existing skills in .claude/skills/

The plugin includes 18 bundled skills (may be newer versions).
Would you like to update/replace them?

Options:
  [1] Replace all with bundled skills (Recommended)
      - Overwrites existing skills with latest versions from plugin
      - activerecord-patterns, service-object-patterns, hotwire-patterns, etc.

  [2] Keep existing skills
      - Don't modify .claude/skills/
      - Continue with current skills

  [3] Merge (add missing only)
      - Keep existing skills
      - Add any new skills not already present
```

### Case B: Skills Directory Empty or Missing

If `.claude/skills/` is empty or missing, use AskUserQuestion to offer:

```
No skills found in .claude/skills/

The plugin includes 18 bundled skills for Rails development.
Would you like to copy them to your project?

Options:
  [1] Copy all bundled skills (Recommended)
      - activerecord-patterns, service-object-patterns, hotwire-patterns
      - rspec-testing-patterns, rails-conventions, rails-error-prevention
      - viewcomponents-specialist, sidekiq-async-patterns, and 10 more

  [2] Copy only core skills (3 skills)
      - rails-conventions, rails-error-prevention, codebase-inspection

  [3] Skip - I'll add skills manually later
```

### Copy/Replace Skills Based on User Choice

**Important**: Use `$PLUGIN_ROOT` variable from Phase 1 (set via `${CLAUDE_PLUGIN_ROOT}`).

**Replace all / Copy all bundled skills**:
```bash
mkdir -p .claude/skills
# Remove existing to ensure clean state
rm -rf .claude/skills/*
cp -r "$PLUGIN_ROOT/skills/"* .claude/skills/
echo "Copied 18 skills to .claude/skills/"
```

**Copy only core skills**:
```bash
mkdir -p .claude/skills
cp -r "$PLUGIN_ROOT/skills/rails-conventions" .claude/skills/
cp -r "$PLUGIN_ROOT/skills/rails-error-prevention" .claude/skills/
cp -r "$PLUGIN_ROOT/skills/codebase-inspection" .claude/skills/
echo "Copied 3 core skills to .claude/skills/"
```

**Merge (add missing only)**:
```bash
mkdir -p .claude/skills
for skill_dir in "$PLUGIN_ROOT/skills/"*/; do
  skill_name=$(basename "$skill_dir")
  if [ ! -d ".claude/skills/$skill_name" ]; then
    cp -r "$skill_dir" ".claude/skills/"
    echo "Added missing skill: $skill_name"
  fi
done
```

## Phase 3: Generate Configuration File

Create or update `.claude/reactree-rails-dev.local.md`:

```markdown
---
smart_detection_enabled: true
detection_mode: suggest
annoyance_threshold: medium
---

# ReAcTree Configuration

This file was generated by `/reactree-init`.

## Settings

- **smart_detection_enabled**: Enable auto-triggering based on prompt analysis
- **detection_mode**: `suggest` (show suggestions) | `inject` (auto-activate) | `disabled`
- **annoyance_threshold**: `low` (minimal triggers) | `medium` | `high` (frequent triggers)

## Available Skills

<!-- Auto-populated by skill discovery -->
```

Then scan and categorize skills:

```bash
# Scan skills and categorize
for skill_dir in .claude/skills/*/; do
  skill_name=$(basename "$skill_dir")
  echo "Found skill: $skill_name"
done
```

Categorize skills into:
- **Core**: rails-conventions, rails-error-prevention, codebase-inspection, rails-context-verification
- **Data**: activerecord-patterns
- **Service**: service-object-patterns, sidekiq-async-patterns, api-development-patterns
- **UI**: hotwire-patterns, viewcomponents-specialist, tailadmin-patterns
- **Testing**: rspec-testing-patterns
- **Domain**: localization, requirements-writing, ruby-oop-patterns
- **Plugin**: reactree-patterns, smart-detection, skill-discovery, workflow-orchestration, beads-integration

## Phase 4: Initialize Memory Files

Create memory files if they don't exist:

```bash
# Working memory
if [ ! -f .claude/reactree-memory.jsonl ]; then
  touch .claude/reactree-memory.jsonl
  echo '{"initialized": true, "timestamp": "'$(date -Iseconds)'"}' >> .claude/reactree-memory.jsonl
fi

# Episodic memory
if [ ! -f .claude/reactree-episodes.jsonl ]; then
  touch .claude/reactree-episodes.jsonl
fi

# Feedback state
if [ ! -f .claude/reactree-feedback.jsonl ]; then
  touch .claude/reactree-feedback.jsonl
fi

# Control flow state
if [ ! -f .claude/reactree-state.jsonl ]; then
  touch .claude/reactree-state.jsonl
fi
```

## Phase 5: Status Report

After completing all phases, output a comprehensive status report:

```
ğŸš€ ReAcTree Plugin Initialized!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Prerequisites:
  âœ… Plugin located at: $PLUGIN_ROOT
  âœ… Hooks configured (SessionStart, UserPromptSubmit)
  âœ… Scripts executable

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Skills Discovered (X total):
  ğŸ“¦ Core: [list skills]
  ğŸ’¾ Data: [list skills]
  âš™ï¸ Service: [list skills]
  ğŸ¨ UI: [list skills]
  ğŸ§ª Testing: [list skills]
  ğŸŒ Domain: [list skills]

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Configuration:
  âœ… Config file: .claude/reactree-rails-dev.local.md
  ğŸ“Š Smart Detection: ENABLED (suggest mode)
  ğŸšï¸ Annoyance Threshold: medium

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Memory Initialized:
  âœ… Working memory: .claude/reactree-memory.jsonl
  âœ… Episodic memory: .claude/reactree-episodes.jsonl
  âœ… Feedback state: .claude/reactree-feedback.jsonl
  âœ… Control flow state: .claude/reactree-state.jsonl

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Available Commands:
  /reactree-dev      - Full development workflow with parallel execution
  /reactree-feature  - Feature-driven development with user stories
  /reactree-debug    - Systematic debugging workflow
  /reactree-refactor - Safe refactoring with test preservation

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Auto-Triggering Examples:
  "Add user authentication"     â†’ suggests /reactree-dev
  "Fix the payment bug"         â†’ suggests /reactree-debug
  "Refactor the user service"   â†’ suggests /reactree-refactor
  "Find payment controller"     â†’ routes to file-finder agent

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Ready to use! Try one of the commands above or just describe what you want to build.
```

## Error Handling

If any phase fails, provide clear error messages:

### Plugin Location Not Detected
```
âŒ Plugin Location Not Detected

The CLAUDE_PLUGIN_ROOT environment variable is not set and no local
plugin installation was found at .claude/plugins/reactree-rails-dev/

This usually means:
  1. The plugin is not properly installed
  2. The plugin was installed but Claude Code isn't setting the root path

To install locally:
  mkdir -p .claude/plugins
  cp -r /path/to/reactree-rails-dev .claude/plugins/

Or install via Claude Code marketplace:
  /install-plugin reactree-rails-dev
```

### Hooks Not Configured
```
âš ï¸ Hooks Configuration Issue

hooks.json not found or invalid at:
  $PLUGIN_ROOT/hooks/hooks.json

This may prevent auto-triggering from working.
The plugin will still work with manual /reactree-* commands.
```

### Scripts Not Executable
```
âš ï¸ Scripts Need Execute Permission

Run these commands to fix:
  chmod +x "$PLUGIN_ROOT/hooks/scripts/"*.sh
```

## Idempotent Design

This command is safe to run multiple times:
- Existing config file is preserved (not overwritten)
- Memory files are created only if missing
- Skills are only copied if directory is empty
- Status report always shows current state
